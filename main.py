# main.py
import uuid
from datetime import datetime

# å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from lm_studio_rag.storage import RAGStorage
from lm_studio_rag.lm_studio_client import LMStudioClient
from architecture.concrete_understanding.base import ConcreteUnderstanding
from architecture.concrete_understanding.schema_architecture import EpisodeData
from architecture.user_response.generator import UserResponseGenerator

def setup_storage() -> RAGStorage:
    """RAGStorageã‚’åˆæœŸåŒ–ã—ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹"""
    print("RAGã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...")
    # æ°¸ç¶šåŒ–ãƒ¢ãƒ¼ãƒ‰ã§åˆæœŸåŒ– (ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã™)
    storage = RAGStorage(USE_MEMORY_RUN=False)

    # --- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ  ---
    # ã“ã“ã§ã¯ç°¡å˜ãªä¾‹ã‚’æ•°ä»¶ã ã‘è¿½åŠ ã—ã¾ã™ã€‚
    # å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚
    print("ã‚µãƒ³ãƒ—ãƒ«ã®çµŒé¨“ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¿½åŠ ã—ã¾ã™ã€‚")
    
    # sample_experience_data= [
    #     "æ˜”ã€çŠ¬ã«è¿½ã„ã‹ã‘ã‚‰ã‚Œã¦æ€–ã„æ€ã„ã‚’ã—ãŸ",
    #     "å­ä¾›ã®é ƒã€äººæ‡ã£ã“ã„çŠ¬ã¨éŠã‚“ã§æ¥½ã—ã‹ã£ãŸ",
    #     "ç§ã¯ã‚‚ã¨ã‚‚ã¨å‹•ç‰©ãŒå¥½ãã "
    # ]
    sample_experience_data = [
        "å¹¼å°‘æœŸã«ã€å‘¨å›²ã«å®¶ãŒã‚ã‚‹ç”°èˆã¨éƒ½ä¼šã®ä¸­é–“ãã‚‰ã„ã®éƒ½å¸‚ã§è‚²ã£ãŸã€‚å°å­¦4å¹´ç”Ÿã®æ™‚ã«Tokyo Game Showã«è¡Œã£ãŸã“ã¨ãŒãã£ã‹ã‘ã§ã€ã‚²ãƒ¼ãƒ åˆ¶ä½œã«èˆˆå‘³ã‚’æŒã¡ã€3ãƒ¶æœˆã‹ã‘ã¦ã‚¯ã‚½ã‚²ãƒ¼ã‚’ä½œã£ãŸã€‚",
        "å°å­¦æ ¡ã®å…ˆç”Ÿã®å½±éŸ¿ã‚’å¼·ãå—ã‘ã€ä½œã‚Œã°è‡ªåˆ†ã®æ¬²ã‚’å¶ãˆã‚‰ã‚Œã‚‹ã¨ã„ã†è€ƒãˆæ–¹ã‚’å­¦ã‚“ã ã€‚å‘¨å›²ã‹ã‚‰ã¯ã€Œèãé­”ã€ã¨å‘¼ã°ã‚Œã‚‹ã€‚",
        "å¼·è¿«è¦³å¿µãŒã‚ã‚Šã€è¬ã®å¤©ä½¿ã¨æ‚ªé­”ã®ã‚ˆã†ãªå­˜åœ¨ãŒé ­ã®ä¸­ã«ç¾ã‚Œã‚‹ã€‚ç¤¾ä¼šçš„ã«ã¾ãšã„ã¨æ€ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ä»–äººã«ã¯ã‚ã¾ã‚Šè©±ã•ãªã„ã€‚",
        "ä»Šã‚’å…¨åŠ›ã§ç”Ÿãã‚‹ã“ã¨ã‚’é‡è¦–ã—ã€çœŸé¢ç›®ã§é›†ä¸­åŠ›ãŒã‚ã‚‹ã€‚ä¸€æ–¹ã§è¦–é‡ãŒç‹­ãã€ä¸æ³¨æ„ãªé¢ã‚‚ã‚ã‚‹ã€‚å‘¨å›²ã‹ã‚‰ã¯çœŸé¢ç›®ãªæ€§æ ¼ã§ã€å“²å­¦ãŒå¥½ããªå¤‰ã‚ã‚Šè€…ã ã¨è¨€ã‚ã‚Œã‚‹ã€‚",
        "è£åˆ‡ã‚‰ãªã„ã“ã¨ã‚’æœ€ã‚‚å¤§åˆ‡ã«ã—ã€è‡ªåˆ†ãŒæ±ºã‚ãŸãƒ«ãƒ¼ãƒ«ã¯ç ´ã‚‰ãªã„ã€‚æ¯æ—¥ã‚’å…¨åŠ›ã§ã‚„ã‚‹ã“ã¨ã¯ã‚„ã£ãŸã¨è¨€ãˆã‚‹ç”Ÿãæ–¹ãŒç†æƒ³ã€‚",
        "äººãŒã©ã‚“ãªè€ƒãˆã‚’æŒã£ã¦ã„ã‚‹ã®ã‹ã«èˆˆå‘³ãŒã‚ã‚‹ã€‚è¶£å‘³ã¯ã‚²ãƒ¼ãƒ ä½œã‚Šã§ã€è‡ªåˆ†ã®æ¬²ã‚’å¶ãˆã‚‹ãŸã‚ã«è‡ªç”±ã«è¨­å®šã‚’ç››ã‚Šè¾¼ã‚“ã ã‚²ãƒ¼ãƒ ã‚’åˆ¶ä½œã—ã€è²©å£²ã—ã¦ã„ã‚‹ã€‚",
        "åˆå¯¾é¢ã®äººã¨ã¯ã€ç›¸æ‰‹ãŒå«ŒãŒã‚‰ãªã„ã‚ˆã†ã«å¿ƒãŒã‘ã¦æ¥ã™ã‚‹ã€‚è¦ªã—ã„å‹äººã¨ã¯æœ¬éŸ³ã§è¨€ã„åˆãˆã‚‹é–¢ä¿‚ã‚’ç¯‰ã„ã¦ã„ã‚‹ã€‚äººã¨ã®è·é›¢æ„Ÿã¯æ…é‡ã«èª¿ç¯€ã—ã¦ã„ãã¹ãã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚",
        "å•é¡Œã‚’è§£æ±ºã—ãŸæ™‚ã‚„ã€ä½œã£ãŸã‚‚ã®ã§äººãŒå¹¸ã›ã«ãªã£ãŸæ™‚ã«å–œã³ã‚’æ„Ÿã˜ã‚‹ã€‚å¤§åˆ‡ã«ã—ã¦ã„ã‚‹äººã‚„ç‰©ãŒè‡ªåˆ†ã®ã›ã„ã§è¢«å®³ã‚’è¢«ã£ãŸæ™‚ã«æ‚²ã—ã¿ã‚’æ„Ÿã˜ã€å¤§åˆ‡ã«ã—ã¦ã„ãŸã‚‚ã®ãŒå£Šã•ã‚ŒãŸæ™‚ã«æ€’ã‚Šã‚’æ„Ÿã˜ã‚‹ã€‚åŒã˜å•é¡Œã«å¯¾ã—ã¦é€²æ—ãŒã‚ã¾ã‚Šæ„Ÿã˜ã‚‰ã‚Œãªã„æ™‚ã«ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ã‚„ã™ã„ã€‚",
        "å°†æ¥ã¯ã©ã‚“ãªèª²é¡Œã§ã‚‚ã‚ˆã‚Šè‰¯ãã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã‚‚ã®ã‚’æå‡ºã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚è‡ªåˆ†ãŒä½œã£ãŸã‚‚ã®ã§è‡ªåˆ†ãŒã‚ˆã‚Šæ¥½ã«æš®ã‚‰ã›ã‚‹ã‚ˆã†ãªäººç”Ÿã‚’é€ã‚ŠãŸã„ã€‚ä»Šå¾Œã®ä¸–ä»£ãŒå°‘ã—ã§ã‚‚ç¶šã„ã¦ãã‚Œã‚‹ã‚ˆã†ãªç¤¾ä¼šã‚’å®Ÿç¾ã—ãŸã„ã€‚",
        "ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã«å¿œå‹Ÿã—ã‚ˆã†ã¨ã—ãŸãŒæœŸé™åˆ‡ã‚Œã§å¿œå‹Ÿã§ããªã‹ã£ãŸã€‚ã“ã®çµŒé¨“ã‹ã‚‰ã€æ—©ã„æ®µéšã§è¡Œå‹•ã™ã‚‹ã“ã¨ã€ã ã‚‰ã ã‚‰ã—ãªã„ã“ã¨ã€ç¾å®Ÿã‚’ç›´è¦–ã™ã‚‹ã“ã¨ã®é‡è¦æ€§ã‚’å­¦ã‚“ã ã€‚",
        "ç¾å®Ÿã¨ç†æƒ³ã®é–“ã§è‘›è—¤ã—ã¦ã„ã‚‹ã€‚ã‚„ã‚ŠãŸã„ã“ã¨ãŒãŸãã•ã‚“ã‚ã‚‹ãŒã€ä»Šã‚„ã£ã¦ã„ã‚‹ã“ã¨ã‚’ä¿®äº†ã™ã‚‹ã¾ã§ã¯ãã‚Œã‚’ã™ã‚‹ã“ã¨ãŒè¨±ã•ã‚Œãªã„ãŸã‚ã€å„ªå…ˆé †ä½ã‚’ã¤ã‘ã–ã‚‹ã‚’å¾—ãªã„çŠ¶æ³ã€‚",
        "è‡ªåˆ†ãŒè€ƒãˆãŸã“ã¨ãŒå¶ã£ãŸæ™‚ã«å¬‰ã—ã•ã‚’æ„Ÿã˜ã€ä»–è€…ã‚„è‡ªåˆ†ã®å¤§åˆ‡ãªã‚‚ã®ã«å±å®³ãŒåŠ ãˆã‚‰ã‚ŒãŸæ™‚ã«æ‚²ã—ã¿ã‚„æ€’ã‚Šã‚’æ„Ÿã˜ã‚‹ã€‚è‡ªåˆ†ãŒã‚„ã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã„ã“ã¨ã‚’ã—ã¦ã„ãªã„æ™‚ã«ä¸å®‰ã‚’æ„Ÿã˜ã‚‹ã€‚",
        "ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸæ™‚ã«ã‚„ã‚‹ã¹ãã“ã¨ã«åŠ›ã‚’å…¥ã‚Œã‚‹ã€‚è‡ªåˆ†ãŒæ±ºã‚ãŸã“ã¨ã¯å¾—æ„ã§ã€ç´ ç›´ã«ãƒŸã‚¹ã‚’èªã‚ã‚„ã™ã„ã€‚ç„¡æ„è­˜ã®ã†ã¡ã«ä½•ãŒå•é¡Œã‹ã‚’è€ƒãˆã¦ã„ã‚‹ã€‚",
        "ä½•ã‹ã‚’æ±ºæ–­ã™ã‚‹æ™‚ã¯ã€ç¾çŠ¶ãŒè‰¯ããªã‚‹ã‹ã‚’è€ƒãˆã‚‹ã€‚å•é¡Œã‚’è§£æ±ºã™ã‚‹æ™‚ã¯ã€è¦³å¯Ÿ->æ¤œè¨¼ -> è§£æ±ºç­– -> è§£æ±ºã¨ã„ã†æ‰‹é †ã‚’è¸ã‚€ã€‚æ–°ã—ã„ã“ã¨ã‚’å­¦ã¶æ™‚ã¯ã€ã¾ãšä½•ã®ãŸã‚ã®å­¦ã³ã‹ã‚’è¦³å¯Ÿã—ã€å…·ä½“ä¾‹ã‚’å­¦ã‚“ã§ã‹ã‚‰æ¦‚å¿µã¨ã—ã¦æ‰ãˆã‚‹ã€‚",
        "ã€Œç§ã¯ã€ã¨ã„ã†è¨€è‘‰ã‚’ã‚ˆãä½¿ã†ã€‚é ·ã„ãŸã‚Šè‚¯å®šã™ã‚‹ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚’ã™ã‚‹ãŒã€å¿ƒã®ä¸­ã§ã¯ãŸã ã®æƒ…å ±ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã€‚",
        "æ ¹æœ¬çš„ãªä¾¡å€¤è¦³ã¯ã‚ã¾ã‚Šå¤‰ã‚ã£ã¦ã„ãªã„ãŒã€å¶ãˆã‚‰ã‚Œã‚‹ã‚‚ã®ã¯é™ã‚Šå°‘ãªã„ã®ã§å„ªå…ˆé †ä½ã‚’ã—ã£ã‹ã‚Šè€ƒãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚",
        "äººã«èãã¾ãã‚‹äººé–“ã®è€ƒãˆã‚’çŸ¥ã‚‹ã®ãŒå¥½ããªç”Ÿå‘½ä½“ã ã¨è€ƒãˆã¦ã„ã‚‹ã€‚é•·æ‰€ã¯é›†ä¸­ã™ã‚‹æ™‚é–“ãŒé•·ã„ã“ã¨ã§ã€çŸ­æ‰€ã¯ä¸æ³¨æ„ã§ã‚ã‚‹ã“ã¨ã€‚ä»–äººã‹ã‚‰ã¯äººã«èãã¾ãã‚‹äººã ã¨æ€ã‚ã‚Œã¦ã„ã‚‹ã€‚",
        "ä»–äººã¨æ„è¦‹ãŒå¯¾ç«‹ã—ãŸå ´åˆã¯ã€ã§ãã‚‹ã ã‘ç´å¾—ãŒã„ãã‚ˆã†ã«ã™ã‚‹ãŒã€è€ƒãˆæ–¹ãŒé•ã†ãªã‚‰é›¢ã‚Œã‚‹ã€‚äººé–“é–¢ä¿‚ã§ãƒˆãƒ©ãƒ–ãƒ«ãŒèµ·ããŸå ´åˆã¯ã€è²¬ä»»ã®ã‚ã‚Šã©ã“ã‚ã‚’æ˜ç¤ºã—ã¦è§£æ±ºã—ã‚ˆã†ã¨ã™ã‚‹ãŒã€ãƒ€ãƒ¡ãªã‚‰é€ƒã’ã‚‹ã€‚å¯¾ç«‹ã‚„ãƒˆãƒ©ãƒ–ãƒ«ã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€è‡ªåˆ†ã®è€ƒãˆã‚’ã‚ã¾ã‚Šæ˜ç¢ºã«å®šç¾©ã—ãªã„ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚",
        "äººé–“ã«å¯¾ã—ã¦å¥½ãã ã¨è¨€ã£ãŸã“ã¨ã‚’å¦å®šã•ã‚ŒãŸã“ã¨ãŒå°è±¡ã«æ®‹ã£ã¦ã„ã‚‹ã€‚Tokyo Game Showã§ã‚²ãƒ¼ãƒ åˆ¶ä½œè€…ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘ã‚‰ã‚ŒãŸã“ã¨ãŒæˆåŠŸä½“é¨“ã€‚æˆ‘ã‚’çŸ¥ã‚‰ãªã„äººã«è¦‹ã›ã¦å¼•ã‹ã‚ŒãŸæ™‚ã«å°å‡ºã—ã«ã™ã‚‹ã“ã¨ã®ãƒªã‚¹ã‚¯ã‚’å­¦ã‚“ã ã€‚",
        "å°†æ¥ã«å¯¾ã™ã‚‹ä¸å®‰ã¯ã‚ã¾ã‚Šãªã„ã€‚è‡ªåˆ†ãŒè‰¯ããªã£ãŸç´ æ•µãªæœªæ¥ãŒã‚ã‚‹ã ã‚ã†ã¨è€ƒãˆã¦ã„ã‚‹ã€‚ã©ã“ã§æ­»ã‚“ã§ã‚‚è‰¯ã„ã€ä»Šã‚’å…¨åŠ›ã«ç”Ÿãã‚Œã‚‹ã‚ˆã†ãªäººã§ã‚ã‚ŠãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ã€‚"
    ]
    
    for d in sample_experience_data:
        storage.save_experience_data(
            text=d,
            metadata={"source": "initial_data"}
        )
 
    print("ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")
    return storage

def main_cli():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçŠ¶æ³ã‚’å…¥åŠ›ã—ã€AIã®å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹CLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"""

    storage = setup_storage()
    lm_client = LMStudioClient()

    # å„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
    concrete_process = ConcreteUnderstanding(storage=storage, lm_client=lm_client)
    response_gen = UserResponseGenerator(lm_client=lm_client)

    print("\n--- è‡ªå·±åˆ†æAIã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ --- V1.1")
    print("ã‚ãªãŸã®èº«ã®å›ã‚Šã§èµ·ãã¦ã„ã‚‹çŠ¶æ³ã‚’æ–‡ç« ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

    while True:
        try:
            field_info_input = input("\nçŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (çµ‚äº†ã™ã‚‹ã«ã¯ 'exit' ã¨å…¥åŠ›): > ")
            if field_info_input.lower() == 'exit':
                print("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã€‚")
                break
            if not field_info_input:
                continue
            print("\033[37;43m-----section1[æŠ½è±¡çš„ç†è§£ã®æ¨è«–]--------\033[0m")
            print("\næ¨è«–ã‚’å®Ÿè¡Œä¸­... (å¿œç­”ã¾ã§æ•°ç§’ã‹ã‹ã‚Šã¾ã™)")

            # 1. æŠ½è±¡çš„ç†è§£ã®å–å¾—
            abstract_result = concrete_process.start_inference(field_info_input)
            if not abstract_result:
                print("ã‚¨ãƒ©ãƒ¼: æŠ½è±¡çš„ç†è§£ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
                continue
            
            print("\033[37;43m-----section2[å…·ä½“çš„ç†è§£ã®æ¨è«–]--------\033[0m")
            
            # 2. å…·è±¡çš„ç†è§£ãƒ‡ãƒ¼ã‚¿ã®ç°¡æ˜“ç”Ÿæˆ (CLIå…¥åŠ›ã‹ã‚‰ä½œæˆ)
            concrete_info = EpisodeData(
                episode_id=str(uuid.uuid4()),
                thread_id="cli_thread",
                timestamp=datetime.now(),
                sequence_in_thread=0,
                source_type="user_cli_input",
                author="user",
                content_type="situational_description",
                text_content=field_info_input,
                status="active",
                sensitivity_level="medium"
            )
            print("\033[37;43m-----section3[æœ€çµ‚å¿œç­”ã®æ¨è«–]--------\033[0m")
            # 3. æœ€çµ‚å¿œç­”ã®ç”Ÿæˆ
            final_response = response_gen.generate(
                abstract_info=abstract_result,
                concrete_info=concrete_info,
                field_info=field_info_input
            )

            print("\033[37;43m-----section4[æ€è€ƒã®è¡¨ç¤º]--------\033[0m")
            # 4. çµæœã®è¡¨ç¤º
            print("\n--- æ¨è«–çµæœ ---")
            print(f"ğŸ¤” æ¨è«–ã•ã‚ŒãŸæ„æ€æ±ºå®š: {final_response.inferred_decision}")
            print(f"ğŸƒ æ¨è«–ã•ã‚ŒãŸè¡Œå‹•: {final_response.inferred_action}")
            
            print("\n--- æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ ---")
            if final_response.thought_process:
                for key, value in final_response.thought_process.items():
                    print(f"- {key}: {value}")
            
            print("\n--- AIã‹ã‚‰ã®å¿œç­” ---")
            print(f"- NUANCE: {final_response.nuance}")
            print(f"- DIALOGUE: {final_response.dialogue}")
            print(f"- BEHAVIOR: {final_response.behavior}")
            print("--------------------")

        except Exception as e:
            print(f"\näºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
            print("å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚")

if __name__ == "__main__":
    main_cli()
